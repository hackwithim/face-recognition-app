{% extends "base.html" %}

{% block title %}Admin Panel - Face Recognition System{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        min-height: 100vh;
    }
    
    .admin-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        margin: 20px;
        padding: 0;
        overflow: hidden;
    }
    
    .admin-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 20px 20px 0 0;
        position: relative;
        overflow: hidden;
    }
    
    .admin-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(180deg); }
    }
    
    .admin-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: relative;
        z-index: 1;
    }
    
    .admin-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 10px 0 0 0;
        position: relative;
        z-index: 1;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: none;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        overflow: hidden;
        position: relative;
        margin-bottom: 20px;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
    
    .stats-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient);
    }
    
    .stats-card.primary::before {
        --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .stats-card.success::before {
        --gradient: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    }
    
    .stats-card.info::before {
        --gradient: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
    }
    
    .stats-card.warning::before {
        --gradient: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: 700;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0;
    }
    
    .stats-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }
    
    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        background: var(--gradient);
    }
    
    .login-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: none;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .login-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
    }
    
    .login-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: float 6s ease-in-out infinite;
    }
    
    .login-form {
        padding: 40px;
    }
    
    .form-control {
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.8);
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: white;
        transform: translateY(-2px);
    }
    
    .btn-modern {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 12px;
        padding: 14px 28px;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .btn-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }
    
    .btn-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    
    .btn-modern:hover::before {
        left: 100%;
    }
    
    .data-table {
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-top: 30px;
    }
    
    .table-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px 30px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .table-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #374151;
        margin: 0;
    }
    
    .search-filter-bar {
        padding: 20px 30px;
        background: #f8f9fa;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .table thead th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        border: none;
        padding: 15px;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .table tbody tr {
        transition: all 0.3s ease;
    }
    
    .table tbody tr:hover {
        background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
        transform: scale(1.01);
    }
    
    .table tbody td {
        padding: 15px;
        vertical-align: middle;
        border-color: #e2e8f0;
    }
    
    .badge-modern {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .badge-success {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
    }
    
    .badge-warning {
        background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        color: white;
    }
    
    .action-buttons .btn {
        margin: 0 2px;
        border-radius: 8px;
        padding: 8px 12px;
        transition: all 0.3s ease;
    }
    
    .action-buttons .btn:hover {
        transform: translateY(-2px);
    }
    
    .floating-add-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-size: 1.5rem;
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        transition: all 0.3s ease;
        z-index: 1000;
    }
    
    .floating-add-btn:hover {
        transform: scale(1.1) rotate(90deg);
        box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
    }
    
    @media (max-width: 768px) {
        .admin-container {
            margin: 10px;
            border-radius: 16px;
        }
        
        .admin-header {
            padding: 20px;
            border-radius: 16px 16px 0 0;
        }
        
        .admin-title {
            font-size: 2rem;
        }
        
        .stats-card {
            margin-bottom: 15px;
        }
        
        .floating-add-btn {
            bottom: 20px;
            right: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Admin Panel -->
<div id="adminPanel" style="display: block;">
    <div class="admin-container">
        <!-- Header Section -->
        <div class="admin-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="admin-title">
                        <i class="fas fa-tachometer-alt me-3"></i>
                        Admin Dashboard
                    </h1>
                    <p class="admin-subtitle">
                        Face Recognition System Management Portal
                    </p>
                </div>
                <div class="d-flex gap-3">
                    <button type="button" class="btn btn-light btn-modern" onclick="refreshData()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Data
                    </button>
                    <button type="button" class="btn btn-light btn-modern" onclick="logout()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Content Section -->
        <div class="p-4">

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="stats-card primary">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stats-label">Total Users</div>
                                    <div class="stats-number primary" style="--gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" id="adminTotalUsers">-</div>
                                </div>
                                <div class="stats-icon" style="--gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="stats-card success">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stats-label">Active Users</div>
                                    <div class="stats-number success" style="--gradient: linear-gradient(135deg, #48bb78 0%, #38a169 100%);" id="adminActiveUsers">-</div>
                                </div>
                                <div class="stats-icon" style="--gradient: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                                    <i class="fas fa-user-check"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="stats-card info">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stats-label">Trained Users</div>
                                    <div class="stats-number info" style="--gradient: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);" id="adminTrainedUsers">-</div>
                                </div>
                                <div class="stats-icon" style="--gradient: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);">
                                    <i class="fas fa-brain"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="stats-card warning">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stats-label">Departments</div>
                                    <div class="stats-number warning" style="--gradient: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);" id="adminDepartments">-</div>
                                </div>
                                <div class="stats-icon" style="--gradient: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);">
                                    <i class="fas fa-building"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Management Table -->
            <div class="data-table">
                <div class="table-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="table-title">
                            <i class="fas fa-users me-2"></i>User Management
                        </h5>
                    </div>
                </div>
                
                <!-- Search and Filter Bar -->
                <div class="search-filter-bar">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-start-0" id="userSearch" placeholder="Search by name, email, or Person ID..." onkeyup="debounce(searchUsers, 300)()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="userFilter" onchange="filterUsers(this.value)">
                                <option value="all">All Users</option>
                                <option value="active">Active Users</option>
                                <option value="inactive">Inactive Users</option>
                                <option value="trained">Face Trained</option>
                                <option value="untrained">Not Trained</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary" onclick="exportUsers()" title="Export Users">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="refreshData()" title="Refresh Data">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Users Table -->
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="usersTable">
                        <thead>
                            <tr>
                                <th>Person ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Face Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <div class="mt-2 text-muted">Loading users...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalName" class="form-label">Full Name *</label>
                                <input type="text" class="form-control" id="modalName" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="modalEmail" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="modalEmail" name="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="modalPhone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="modalPhone" name="phone">
                            </div>
                            <div class="mb-3">
                                <label for="modalAddress" class="form-label">Address</label>
                                <input type="text" class="form-control" id="modalAddress" name="address">
                            </div>
                            <div class="mb-3">
                                <label for="modalCity" class="form-label">City</label>
                                <input type="text" class="form-control" id="modalCity" name="city">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalCollegeName" class="form-label">College/University</label>
                                <input type="text" class="form-control" id="modalCollegeName" name="college_name">
                            </div>
                            <div class="mb-3">
                                <label for="modalDepartment" class="form-label">Department</label>
                                <input type="text" class="form-control" id="modalDepartment" name="department">
                            </div>
                            <div class="mb-3">
                                <label for="modalCourse" class="form-label">Course</label>
                                <input type="text" class="form-control" id="modalCourse" name="course">
                            </div>
                            <div class="mb-3">
                                <label for="modalYearOfStudy" class="form-label">Year of Study</label>
                                <select class="form-select" id="modalYearOfStudy" name="year_of_study">
                                    <option value="">Select Year</option>
                                    <option value="1st Year">1st Year</option>
                                    <option value="2nd Year">2nd Year</option>
                                    <option value="3rd Year">3rd Year</option>
                                    <option value="4th Year">4th Year</option>
                                    <option value="Graduate">Graduate</option>
                                </select>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="modalIsActive" name="is_active" checked>
                                <label class="form-check-label" for="modalIsActive">
                                    Active User
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">Save User</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId" name="user_id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editName" class="form-label">Full Name *</label>
                                <input type="text" class="form-control" id="editName" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="editEmail" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="editEmail" name="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="editPhone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="editPhone" name="phone">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editEmployeeId" class="form-label">Employee ID</label>
                                <input type="text" class="form-control" id="editEmployeeId" name="employee_id">
                            </div>
                            <div class="mb-3">
                                <label for="editDepartment" class="form-label">Department</label>
                                <select class="form-select" id="editDepartment" name="department">
                                    <option value="">Select Department</option>
                                    <option value="Administration">Administration</option>
                                    <option value="Human Resources">Human Resources</option>
                                    <option value="IT">Information Technology</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Operations">Operations</option>
                                    <option value="Sales">Sales</option>
                                    <option value="Security">Security</option>
                                </select>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editIsActive" name="is_active">
                                <label class="form-check-label" for="editIsActive">
                                    Active User
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateUser()">Update User</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allUsers = [];
    let filteredUsers = [];
    let currentFilter = 'all';
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Admin dashboard loaded');
        
        // Check if user is authenticated
        const token = localStorage.getItem('access_token');
        if (!token) {
            console.log('No token found, redirecting to login');
            window.location.href = '/login';
            return;
        }
        
        console.log('Token found, loading admin data');
        // Load data
        setupEventListeners();
        loadAdminData();
    });
    
    function setupEventListeners() {
        const userSearch = document.getElementById('userSearch');
        if (userSearch) {
            userSearch.addEventListener('input', debounce(searchUsers, 300));
        }
    }
    
    // Helper function for authenticated API requests
    async function apiRequest(url, options = {}) {
        const token = localStorage.getItem('access_token');
        
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            }
        };
        
        const mergedOptions = {
            ...defaultOptions,
            ...options,
            headers: {
                ...defaultOptions.headers,
                ...options.headers
            }
        };
        
        const response = await fetch(url, mergedOptions);
        
        if (response.status === 401) {
            localStorage.removeItem('access_token');
            showAlert('Session expired. Please login again.', 'warning');
            showLoginSection();
            return null;
        }
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.message || 'Request failed');
        }
        
        return data;
    }

    async function loadAdminData() {
        try {
            await Promise.all([
                loadUsers(),
                loadAdminStats()
            ]);
        } catch (error) {
            console.error('Failed to load admin data:', error);
            showAlert('Failed to load admin data: ' + error.message, 'danger');
        }
    }
    
    async function loadUsers() {
        try {
            const response = await apiRequest('/api/users?per_page=100');
            if (response) {
                allUsers = response.users;
                filteredUsers = allUsers;
                updateUsersTable();
            }
        } catch (error) {
            console.error('Failed to load users:', error);
            throw error;
        }
    }
    
    async function loadAdminStats() {
        try {
            // Calculate stats from already loaded users (faster)
            const totalUsers = allUsers.length;
            const activeUsers = allUsers.filter(u => u.is_active).length;
            const trainedUsers = allUsers.filter(u => u.face_data || u.has_face_data || u.encoding).length;
            const departments = [...new Set(allUsers.map(u => u.department).filter(d => d))];
            
            // Update UI immediately
            document.getElementById('adminTotalUsers').textContent = totalUsers;
            document.getElementById('adminActiveUsers').textContent = activeUsers;
            document.getElementById('adminTrainedUsers').textContent = trainedUsers;
            document.getElementById('adminDepartments').textContent = departments.length;
            
        } catch (error) {
            console.error('Failed to load admin stats:', error);
        }
    }
    
    function updateUsersTable() {
        const tbody = document.getElementById('usersTableBody');
        
        if (filteredUsers.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-5">
                        <div class="text-muted">
                            <i class="fas fa-users fa-3x mb-3 opacity-50"></i>
                            <div class="h5">No users found</div>
                            <p class="mb-0">Try adjusting your search or filter criteria</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        const html = filteredUsers.map(user => `
            <tr>
                <td>
                    <span class="badge badge-modern" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        ${user.person_id || 'N/A'}
                    </span>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="user-avatar me-2" style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.8rem;">
                            ${user.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div class="fw-semibold">${user.name}</div>
                            <small class="text-muted">${user.email}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <a href="mailto:${user.email}" class="text-decoration-none">
                        ${user.email}
                    </a>
                </td>
                <td>
                    ${user.phone ? `<a href="tel:${user.phone}" class="text-decoration-none">${user.phone}</a>` : '<span class="text-muted">Not provided</span>'}
                </td>
                <td>
                    <small class="text-muted">${user.department || 'Not specified'}</small>
                </td>
                <td>
                    <span class="badge-modern ${user.is_active ? 'badge-success' : 'badge-warning'}">
                        <i class="fas fa-${user.is_active ? 'check-circle' : 'pause-circle'} me-1"></i>
                        ${user.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <span class="badge-modern ${(user.face_data || user.has_face_data || user.encoding) ? 'badge-success' : 'badge-warning'}">
                        <i class="fas fa-${(user.face_data || user.has_face_data || user.encoding) ? 'brain' : 'exclamation-triangle'} me-1"></i>
                        ${(user.face_data || user.has_face_data || user.encoding) ? 'Trained' : 'Not Trained'}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})" title="Edit User">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="retrainUser(${user.id})" title="Retrain Face">
                            <i class="fas fa-camera"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})" title="Delete User">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        
        tbody.innerHTML = html;
    }
    
    function filterUsers(filter) {
        currentFilter = filter;
        
        // Update button states
        document.querySelectorAll('.btn-group button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        switch (filter) {
            case 'active':
                filteredUsers = allUsers.filter(u => u.is_active);
                break;
            case 'inactive':
                filteredUsers = allUsers.filter(u => !u.is_active);
                break;
            case 'trained':
                filteredUsers = allUsers.filter(u => u.face_data || u.has_face_data || u.encoding);
                break;
            default:
                filteredUsers = allUsers;
        }
        
        updateUsersTable();
    }
    
    function searchUsers() {
        const query = document.getElementById('userSearch').value.toLowerCase();
        
        if (!query) {
            filterUsers(currentFilter);
            return;
        }
        
        filteredUsers = allUsers.filter(user => 
            user.name.toLowerCase().includes(query) ||
            user.email.toLowerCase().includes(query) ||
            (user.employee_id && user.employee_id.toLowerCase().includes(query)) ||
            (user.department && user.department.toLowerCase().includes(query))
        );
        
        updateUsersTable();
    }
    
    async function saveUser() {
        try {
            const formData = new FormData(document.getElementById('addUserForm'));
            const userData = Object.fromEntries(formData.entries());
            userData.is_active = document.getElementById('modalIsActive').checked;
            
            const response = await apiRequest('/api/register', {
                method: 'POST',
                body: JSON.stringify(userData)
            });
            
            showAlert('User created successfully!', 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
            modal.hide();
            
            // Refresh data
            await loadAdminData();
            
        } catch (error) {
            console.error('Failed to save user:', error);
            showAlert('Failed to save user: ' + error.message, 'danger');
        }
    }
    
    function editUser(userId) {
        const user = allUsers.find(u => u.id === userId);
        if (!user) return;
        
        // Populate edit form
        document.getElementById('editUserId').value = user.id;
        document.getElementById('editName').value = user.name;
        document.getElementById('editEmail').value = user.email;
        document.getElementById('editPhone').value = user.phone || '';
        document.getElementById('editEmployeeId').value = user.employee_id || '';
        document.getElementById('editDepartment').value = user.department || '';
        document.getElementById('editIsActive').checked = user.is_active;
        
        const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
        modal.show();
    }
    
    async function updateUser() {
        try {
            const formData = new FormData(document.getElementById('editUserForm'));
            const userData = Object.fromEntries(formData.entries());
            userData.is_active = document.getElementById('editIsActive').checked;
            
            const userId = userData.user_id;
            delete userData.user_id;
            
            await apiRequest(`/api/users/${userId}`, {
                method: 'PUT',
                body: JSON.stringify(userData)
            });
            
            showAlert('User updated successfully!', 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            modal.hide();
            
            // Refresh data
            await loadAdminData();
            
        } catch (error) {
            console.error('Failed to update user:', error);
            showAlert('Failed to update user: ' + error.message, 'danger');
        }
    }
    
    function retrainUser(userId) {
        const user = allUsers.find(u => u.id === userId);
        if (!user) return;
        
        if (confirm(`Start face capture session for ${user.name}?`)) {
            window.location.href = `/capture/${userId}`;
        }
    }
    
    async function deleteUser(userId) {
        const user = allUsers.find(u => u.id === userId);
        if (!user) return;
        
        if (!confirm(`Are you sure you want to delete ${user.name}? This action cannot be undone.`)) {
            return;
        }
        
        try {
            await apiRequest(`/api/users/${userId}`, {
                method: 'DELETE'
            });
            
            showAlert('User deleted successfully!', 'success');
            
            // Refresh data
            await loadAdminData();
            
        } catch (error) {
            console.error('Failed to delete user:', error);
            showAlert('Failed to delete user: ' + error.message, 'danger');
        }
    }
    
    function showLoading(title, message) {
        // Simple loading indicator - you can enhance this
        console.log(`Loading: ${title} - ${message}`);
    }
    
    function hideLoading() {
        console.log('Loading complete');
    }
    
    function showAlert(message, type = 'info') {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.minWidth = '300px';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
    
    function logout() {
        localStorage.removeItem('access_token');
        window.location.href = '/login';
    }
    
    async function refreshData() {
        try {
            // Show quick loading indicator
            const refreshBtn = document.querySelector('[onclick="refreshData()"]');
            if (refreshBtn) {
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
                refreshBtn.disabled = true;
            }
            
            await loadAdminData();
            showAlert('Data refreshed successfully!', 'success');
            
            // Reset button
            if (refreshBtn) {
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Refresh Data';
                refreshBtn.disabled = false;
            }
        } catch (error) {
            showAlert('Failed to refresh data: ' + error.message, 'danger');
            
            // Reset button on error
            const refreshBtn = document.querySelector('[onclick="refreshData()"]');
            if (refreshBtn) {
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Refresh Data';
                refreshBtn.disabled = false;
            }
        }
    }
    
    // Utility function for debouncing search
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
</script>
{% endblock %}
